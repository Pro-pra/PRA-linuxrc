#!/bin/sh
# –ë—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç –≤–º–µ—Å—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏/–≤—ã–∫–ª—é—á–µ–Ω–∏—è
# —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –≤ –∫–æ—Ä–µ–Ω—å initrd –∏ –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —á—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.
# –í –æ—Å–Ω–æ–≤–Ω–æ–º –Ω—É–∂–µ–Ω –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è changes= –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
# –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª/–ø–∞–ø–∫—É —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏.

export PATH=.:/mnt/live:/usr/sbin:/usr/bin:/sbin:/bin

# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ª—é–±–æ–≥–æ —à–µ–ª–ª–∞
# –æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ union (/union/bin/bash)
if [ ! "$RE_EXEC_CLEANUP" ]; then
   export RE_EXEC_CLEANUP=1
   pivot_root . union
   exec chroot . /cleanup "$@" <dev/console >dev/console 2>&1
   echo "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞—Å –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–¥–µ—Å—å!"
fi

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è(TERM) –ø—Ä–æ—Ü–µ—Å—Å–∞–º –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —É–±–∏—Ç—å:
PID=`ps | sed -n '/PID/,/{cleanup}/p' | egrep -v "\[.*\]" | egrep -v 'PID|cleanup|mount.ntfs' | sed -r "s/^ *([0-9]+).*/\\1/" | tr "\n" " "`
kill -SIGTERM `echo $PID` >/dev/null 2>&1

# –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è cryptsetup —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
[ -b /dev/mapper/crypt ] && cp /memory/images/000-kernel.pfs/sbin/cryptsetup /bin

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –ª–∏ –º—ã —Å CD –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç—ã 'eject':
CD=`grep /dev/sr /proc/mounts | cut -d" " -f1 | uniq`
[ -b "$CD" ] && cp -f /union/usr/bin/eject /bin

# –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–≤–æ–µ–Ω–Ω—ã—Ö –≤—Ö–æ–∂–¥–µ–Ω–∏–π –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ntfs –∏–∑ mtab:
sed -i "/ fuseblk /d" /etc/mtab

if [ -e /tmp/changes-exit ]; then
    echo -e "–í–∞—à–∞ —Å–µ—Å—Å–∏—è –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ [1;33m3[0m —Å–µ–∫—É–Ω–¥.\n–ù–∞–∂–º–∏—Ç–µ –ø—Ä–æ–±–µ–ª/enter —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å –∏–ª–∏ –¥—Ä—É–≥—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞."; x=3
    while [ $x -gt 0 ]; do read -s -t1 -n1 ans && break || sleep 1; let x=x-1; done
    if [ "$ans" = "" ]; then
	DEST=`cat /tmp/changes-exit`; NAME=`basename $DEST`; MNAME=/memory/images/changes; FOLDERS=`grep '^/' /union/etc/changes_exit.conf | sed s/^.//g`
	echo "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ $NAME - –Ω–µ –≤—ã–∫–ª—é—á–∞–π—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä"
	cd /memory/changes; rm -rf var/lock/subsys/* var/run/laptop-mode-tools/* `grep '^!' /union/etc/changes_exit.conf | sed s/^..//g | tr "\n" " "`
	for x in `find $FOLDERS -name ".wh.*" 2>/dev/null | sed s/.wh.//g`; do test -e $MNAME/$x && rm -rf $MNAME/$x; done
	for x in `find $MNAME -name ".wh.*" 2>/dev/null`; do wh=`echo $x | sed -e s^$MNAME^^g -e s/.wh.//g`; test -e $wh && rm $x; done
	cp -a $FOLDERS $MNAME 2>/dev/null
    fi
elif ! grep -q memory /var/log/livedbg; then
    sleep 2
fi

# SIGKILL:
kill -SIGKILL `echo $PID` >/dev/null 2>&1
sync

echo "—Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ union"
umount -nl `grep /union/ /proc/mounts | cut -d" " -f2 | tr "\n" " "` 2>/dev/null
umount /union 2>/dev/null
if [ $? -ne 0 ]; then
    x=9; free=no
    while [ $x -gt 0 -a $free = no ]; do
	usleep 300000; sync; let x=x-1
	umount /union 2>/dev/null && { echo "union —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ"; free=yes; }
    done
    if [ $? -ne 0 ]; then
	echo "–ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ union –≤ read-only"
	echo -e "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ '[1;33mfsck[0m' cheatcode –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ\n—á—Ç–æ–±—ã —É–¥–æ—Å—Ç–æ–≤–µ—Ä–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –≤–∞—à–∏ —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã !!!consistent"
	sleep 3; umount -r /union 2>/dev/null
    fi
fi

echo "–æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–æ—á–µ–≥–æ"
umount -a 2>/dev/null
if [ $? -ne 0 ]; then
    # –ó–∞–∫—Ä—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
    if [ -b /dev/mapper/crypt ]; then
        cryptsetup luksClose crypt
        losetup -d /dev/loop2
    fi
    umount -ar 2>/dev/null
fi

# –ò–∑–≤–ª–µ—á—å cdrom –ø—Ä–∏–≤–æ–¥:
if [ -z "`egrep -o " noeject( |\$)" /proc/cmdline`" -a -b "$CD" ]; then
    echo "–£–±–µ—Ä–∏—Ç–µ $CD..."; eject $CD 2>/dev/null; x=6
    while [ $x -gt 0 ]; do
	echo -en "–õ–æ—Ç–æ–∫ CD –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ [1;33m$x[0m —Å–µ–∫—É–Ω–¥ - –Ω–∞–∂–º–∏—Ç–µ enter —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å–µ–π—á–∞—Å.\r"
	read -s -t1 && break || sleep 1
	let x=x-1
    done
    eject -t $CD 2>/dev/null
fi

# $1 = action, eg. poweroff or reboot:
if [ "$1" = "" ]; then reboot -f; fi
if [ "$1" = "halt" ]; then poweroff -f; else $1 -f; fi

echo "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞—Å –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–¥–µ—Å—å!"
